# 流式输出功能说明

## 概述

MangoAgent现在支持实时流式输出AI大脑的思考过程，让用户能够看到AI是如何分析问题、调用工具和生成结果的。

## 功能特点

### 🎯 实时思考过程展示
- **思考开始**: 显示"AI正在分析您的请求..."
- **思考内容**: 实时显示AI的思考过程，包括问题分析、计划制定等
- **工具调用**: 显示正在调用的工具名称和参数
- **工具返回**: 显示工具的执行结果
- **思考完成**: 显示"分析完成"和"任务完成"状态

### ⚙️ 可配置的显示选项
- **详细模式**: 显示完整的思考过程和工具调用信息
- **简洁模式**: 只显示最终的思考结果，隐藏中间过程
- **实时切换**: 可以在侧边栏随时切换显示模式

### 🎨 丰富的视觉反馈
- **状态指示器**: 使用不同的图标和颜色表示不同状态
- **进度提示**: 实时显示当前处理阶段
- **错误处理**: 清晰的错误信息显示

## 使用方法

### 1. 启用流式输出
在侧边栏的"流式输出设置"部分：
- 勾选"显示详细思考过程"以启用详细模式
- 取消勾选以使用简洁模式

### 2. 开始对话
在聊天输入框中输入您的问题，例如：
```
帮我把 "颜料果冻动物_v1.json" 和 "猫咪抢鸡块_v1.json" 这两个prompt都用浏览器生成视频
```

### 3. 观察思考过程
启用详细模式后，您将看到：
1. **🤔 AI正在分析您的请求...** - 开始分析
2. **思考内容** - AI的实时思考过程
3. **🛠️ 正在调用工具** - 工具调用信息
4. **✅ 工具返回** - 工具执行结果
5. **✅ 分析完成** - 思考阶段完成
6. **✅ 任务完成** - 整个任务完成

## 技术实现

### 前端 (Streamlit)
- 使用多个占位符分别显示不同类型的输出
- 根据用户设置动态显示/隐藏详细过程
- 实时更新UI状态和进度

### 后端 (FastAPI)
- 使用Server-Sent Events (SSE)实现流式输出
- 支持多种事件类型：thinking_start, thought, tool_start, tool_end, thinking_end, done, error
- 自动格式化工具输出结果

### 事件类型说明

| 事件类型 | 描述 | 前端显示 |
|---------|------|----------|
| `thinking_start` | 开始思考 | 🤔 AI正在分析您的请求... |
| `thought` | 思考内容 | 实时显示AI思考过程 |
| `tool_start` | 工具调用开始 | 🛠️ 正在调用工具信息 |
| `tool_end` | 工具调用结束 | ✅ 工具返回结果 |
| `thinking_end` | 思考完成 | ✅ 分析完成 |
| `done` | 任务完成 | ✅ 任务完成 |
| `error` | 发生错误 | ❌ 错误信息 |

## 配置选项

### 显示详细思考过程
- **启用**: 显示完整的思考过程、工具调用和返回结果
- **禁用**: 只显示最终的思考结果，提高界面简洁性

### 工具输出格式化
- 自动截断过长的输出（超过200字符）
- 美化JSON格式的工具返回结果
- 智能处理不同类型的工具输出

## 最佳实践

### 推荐使用场景
1. **调试和问题排查**: 启用详细模式查看AI的完整思考过程
2. **学习和理解**: 了解AI如何解决问题和调用工具
3. **日常使用**: 使用简洁模式获得更清爽的界面

### 性能考虑
- 详细模式会增加网络传输量
- 建议在网络条件良好时使用详细模式
- 简洁模式适合快速交互和移动设备

## 故障排除

### 常见问题

**Q: 流式输出没有显示？**
A: 检查是否启用了"显示详细思考过程"选项，并确保后端服务正常运行。

**Q: 工具调用信息显示不完整？**
A: 工具输出会自动截断，如需查看完整信息，请查看最终的思考结果。

**Q: 流式输出中断？**
A: 可能是网络问题或后端服务异常，请检查连接状态和错误信息。

### 错误处理
- 网络连接失败时会显示明确的错误信息
- 工具调用失败时会显示具体的错误原因
- 所有错误都会记录在日志中便于排查

## 更新日志

### v1.0.0 (当前版本)
- ✅ 实现基础流式输出功能
- ✅ 支持详细/简洁模式切换
- ✅ 添加丰富的视觉反馈
- ✅ 完善错误处理机制
- ✅ 优化工具输出格式化

### 计划功能
- 🔄 支持自定义显示样式
- 🔄 添加思考过程回放功能
- 🔄 支持导出思考过程日志
- 🔄 添加性能监控和统计
